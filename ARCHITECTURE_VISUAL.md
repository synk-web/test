# SYNK MVP - 전체 시스템 아키텍처 (시각화)

> **업데이트**: 2024년 최신 구조 반영  
> 기존 DEVELOPER_GUIDE.md를 기반으로 현재까지 추가된 모든 기능을 시각적으로 정리

---

## 🏗️ 전체 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          SYNK MVP 시스템 전체 구조                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────┐              ┌──────────────────┐                    │
│  │   프론트엔드      │              │   FastAPI 서버    │                    │
│  │   (index.html)   │◄─────────────┤   (main.py)      │                    │
│  │                  │   HTTP/WS     │                  │                    │
│  │ • 오프닝 선택     │              │ • 라우터 등록    │                    │
│  │ • 채팅 UI        │              │ • CORS 설정      │                    │
│  │ • 연쇄 반응 표시  │              │ • 정적 파일 서빙 │                    │
│  └──────────────────┘              └────────┬─────────┘                    │
│                                              │                               │
│                                              ▼                               │
│  ┌──────────────────────────────────────────────────────────────┐         │
│  │                      API 레이어                                │         │
│  ├──────────────────────────────────────────────────────────────┤         │
│  │                                                               │         │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────┐  │         │
│  │  │ character_api.py │  │  chat_multi.py   │  │opening.py│  │         │
│  │  │                  │  │                  │  │          │  │         │
│  │  │ • 캐릭터 CRUD    │  │ • 멀티 캐릭터     │  │ • 오프닝  │  │         │
│  │  │ • 장소 관리      │  │   채팅           │  │   시나리오│  │         │
│  │  │ • 조회 API       │  │ • 연쇄 반응      │  │ • 게임    │  │         │
│  │  └────────┬─────────┘  │ • 관계 데이터    │  │   시작   │  │         │
│  │           │             │   업데이트       │  │          │  │         │
│  │           │             └────────┬─────────┘  └────┬─────┘  │         │
│  │           │                       │                 │        │         │
│  └───────────┼───────────────────────┼─────────────────┘        │         │
│              │                       │                           │         │
│              ▼                       ▼                           │         │
│  ┌──────────────────────────────────────────────────────────────┐         │
│  │                    Core 로직 레이어                            │         │
│  ├──────────────────────────────────────────────────────────────┤         │
│  │                                                               │         │
│  │  ┌──────────────────┐  ┌──────────────────┐                 │         │
│  │  │speaker_selector  │  │prompt_builder_v2 │                 │         │
│  │  │                 │  │                  │                 │         │
│  │  │ • 화자 선택      │  │ • 프롬프트 생성   │                 │         │
│  │  │ • 멘션 감지      │  │ • 관계 컨텍스트   │                 │         │
│  │  │ • 연쇄 반응      │  │ • 멀티 캐릭터    │                 │         │
│  │  │ • 대화 히스토리  │  │   컨텍스트       │                 │         │
│  │  └────────┬─────────┘  └────────┬─────────┘                 │         │
│  │           │                      │                            │         │
│  │           │                      ▼                            │         │
│  │           │         ┌──────────────────────┐                 │         │
│  │           │         │  data_collector.py    │                 │         │
│  │           │         │                       │                 │         │
│  │           │         │ • 턴 데이터 수집      │                 │         │
│  │           │         │ • 관계 데이터 업데이트 │                 │         │
│  │           │         └───────┬────────────────┘                 │         │
│  │           │                 │                                 │         │
│  │           │                 ▼                                 │         │
│  │           │    ┌─────────────────────────────────────┐        │         │
│  │           │    │  분석 모듈들                        │        │         │
│  │           │    ├─────────────────────────────────────┤        │         │
│  │           │    │ • dominance_calc.py  (권력 구조)    │        │         │
│  │           │    │ • emotion_analyzer.py (감정 분석)   │        │         │
│  │           │    │ • memory_manager.py  (기억 관리)    │        │         │
│  │           │    │ • trigger_detector.py (트리거 감지) │        │         │
│  │           │    └─────────────────────────────────────┘        │         │
│  └───────────┼───────────────────────────────────────────────────┘         │
│              │                                                              │
│              ▼                                                              │
│  ┌──────────────────────────────────────────────────────────────┐         │
│  │                    유틸리티 레이어 (NEW)                      │         │
│  ├──────────────────────────────────────────────────────────────┤         │
│  │                                                               │         │
│  │  ┌──────────────────┐              ┌──────────────────┐     │         │
│  │  │  utils/config.py │              │gemini_client.py   │     │         │
│  │  │                  │              │                  │     │         │
│  │  │ • .env 로드      │─────────────►│ • API 클라이언트  │     │         │
│  │  │ • 환경 변수 관리  │              │ • 응답 생성      │     │         │
│  │  │ • DB URL 관리    │              │ • 에러 핸들링    │     │         │
│  │  └──────────────────┘              └────────┬─────────┘     │         │
│  │                                              │                │         │
│  │                                              ▼                │         │
│  │                                    ┌──────────────────┐      │         │
│  │                                    │  Gemini API      │      │         │
│  │                                    │  (Google AI)     │      │         │
│  │                                    └──────────────────┘      │         │
│  └──────────────────────────────────────────────────────────────┘         │
│                                                                             │
│              ┌──────────────────┐              ┌──────────────────┐        │
│              │   데이터베이스    │              │   데이터베이스    │        │
│              │   레이어         │              │   레이어          │        │
│              ├──────────────────┤              ├──────────────────┤        │
│              │                  │              │                  │        │
│              │character_db.py   │              │  database.py     │        │
│              │                  │              │                  │        │
│              │ • 캐릭터 CRUD    │              │ • 관계 데이터     │        │
│              │ • 장소 관리      │              │   CRUD           │        │
│              │ • DB 초기화      │              │ • DB 초기화      │        │
│              └────────┬─────────┘              └────────┬─────────┘        │
│                       │                                  │                   │
│                       └──────────────┬───────────────────┘                   │
│                                      ▼                                      │
│                            ┌──────────────────┐                              │
│                            │  SQLite DB      │                              │
│                            │  (synk_mvp.db)  │                              │
│                            │                  │                              │
│                            │ • characters     │                              │
│                            │ • locations      │                              │
│                            │ • relationships  │                              │
│                            └──────────────────┘                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📁 파일 구조 (현재 버전)

```
synk-mvp/
│
├── 📄 main.py                    # FastAPI 메인 앱
│   ├── 라우터 등록 (character, chat_multi, opening)
│   ├── CORS 설정
│   ├── 정적 파일 서빙
│   └── DB 초기화
│
├── 📁 models/                    # 데이터 모델
│   ├── character.py              # 캐릭터 페르소나 모델
│   ├── relationship.py           # 관계 데이터 모델
│   └── __init__.py
│
├── 📁 db/                        # 데이터베이스 레이어
│   ├── character_db.py           # 캐릭터 DB CRUD
│   └── database.py               # 관계 데이터 DB CRUD
│
├── 📁 api/                       # API 엔드포인트
│   ├── character_api.py          # 캐릭터 CRUD API
│   ├── chat_multi.py             # 멀티 캐릭터 채팅 API ⭐
│   └── opening.py                # 오프닝 시나리오 API ⭐
│
├── 📁 core/                      # 핵심 비즈니스 로직
│   ├── speaker_selector.py       # 화자 선택 로직 ⭐
│   │   ├── ConversationHistory
│   │   ├── select_speaker()
│   │   ├── detect_mention()
│   │   ├── detect_mentioned_npc() ⭐ (연쇄 반응)
│   │   └── build_conversation_context()
│   │
│   ├── prompt_builder_v2.py      # 프롬프트 빌더
│   │   └── build_relationship_context()
│   │
│   ├── data_collector.py         # 데이터 수집 및 업데이트
│   ├── dominance_calc.py        # Dominance 계산
│   ├── emotion_analyzer.py      # 감정 분석
│   ├── memory_manager.py        # 기억 관리
│   └── trigger_detector.py       # 트리거 감지
│
├── 📁 utils/                     # 유틸리티 모듈 (NEW) ⭐
│   ├── config.py                 # 환경 설정 관리
│   │   ├── load_env()
│   │   ├── get_gemini_api_key()
│   │   └── get_database_url()
│   │
│   ├── gemini_client.py          # Gemini API 클라이언트
│   │   ├── GeminiClient (싱글톤)
│   │   ├── generate_response()
│   │   └── reload_api_key()
│   │
│   └── __init__.py
│
├── 📁 static/                    # 프론트엔드
│   └── index.html                # 채팅 UI ⭐
│       ├── 오프닝 선택 (인-앱)
│       ├── 멀티 캐릭터 채팅
│       └── 연쇄 반응 표시
│
├── 📁 scripts/                   # 유틸리티 스크립트
│   └── seed_characters.py        # 초기 데이터 시딩
│
├── 📄 requirements.txt           # Python 의존성
├── 📄 .env                       # 환경 변수 (GEMINI_API_KEY)
└── 📄 synk_mvp.db               # SQLite 데이터베이스
```

**⭐ 표시**: 기존 가이드 이후 추가된 기능

---

## 🔄 데이터 흐름 (멀티 캐릭터 채팅)

```
[유저 입력]
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│  POST /api/chat/location/{location_id}                  │
│  (chat_multi.py)                                        │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │  장소의 캐릭터들 조회   │
        │  (character_db.py)    │
        └───────────┬─────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │  Speaker Selector     │
        │  (speaker_selector.py)│
        │                       │
        │  1. 멘션 감지         │
        │  2. 문맥 기반 선택     │
        │  3. 랜덤 난입         │
        └───────────┬─────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │  관계 데이터 조회      │
        │  (database.py)         │
        └───────────┬─────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │  프롬프트 생성         │
        │  (prompt_builder_v2)  │
        │                       │
        │  • 캐릭터 페르소나     │
        │  • 관계 컨텍스트       │
        │  • 멀티 캐릭터 컨텍스트│
        │  • 대화 히스토리       │
        └───────────┬─────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │  Gemini API 호출       │
        │  (gemini_client.py)   │
        └───────────┬─────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │  연쇄 반응 체크 ⭐     │
        │  (detect_mentioned_npc)│
        │                       │
        │  NPC가 다른 NPC 언급?  │
        │  → 즉시 응답 생성      │
        └───────────┬─────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │  데이터 수집 및 업데이트│
        │  (data_collector.py)  │
        │                       │
        │  • Dominance 업데이트  │
        │  • 감정 통계 업데이트   │
        │  • 핵심 기억 생성      │
        │  • 트리거 키워드 관리  │
        └───────────┬─────────────┘
                    │
                    ▼
            [응답 반환]
```

---

## 🎯 주요 기능별 구조

### 1. 오프닝 시나리오 시스템

```
[유저 접속]
    │
    ▼
┌─────────────────────────┐
│  채팅방 즉시 진입        │
│  (index.html)           │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│  시스템 메시지 표시      │
│  "명월 아카데미에..."    │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│  선택지 버튼 표시        │
│  (4개 시나리오)          │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│  POST /api/opening/start │
│  (opening.py)           │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│  • 장소 설정             │
│  • 세션 생성             │
│  • 첫 대사 히스토리 추가  │
└───────────┬─────────────┘
            │
            ▼
        [게임 시작]
```

### 2. 연쇄 반응 시스템 (Chain Reaction) ⭐

```
[NPC A 응답 생성]
    │
    ▼
┌─────────────────────────┐
│  응답 텍스트 분석        │
│  (detect_mentioned_npc) │
└───────────┬─────────────┘
            │
            ├─ 다른 NPC 언급? ──YES──► [NPC B 즉시 응답 생성]
            │                                    │
            │                                    ▼
            │                          [연쇄 반응 메시지]
            │                                    │
            │                                    ▼
            │                          [500ms 딜레이 후 표시]
            │
            └─NO──► [유저 입력 대기]
```

### 3. Speaker Selector 로직

```
[유저 메시지]
    │
    ▼
┌─────────────────────────┐
│  1. 멘션 감지           │
│     (이름 언급?)        │
└───────────┬─────────────┘
            │
            ├─YES──► [언급된 캐릭터 응답]
            │
            └─NO──►
                    │
                    ▼
        ┌───────────────────────┐
        │  2. 문맥 기반 선택     │
        │     (마지막 화자)      │
        └───────────┬───────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │  3. 랜덤 난입 체크     │
        │     (3턴 이상 + 20%)   │
        └───────────┬───────────┘
                    │
                    ▼
            [화자 선택 완료]
```

---

## 🔌 API 엔드포인트 전체 목록

### 캐릭터 관리
- `GET /api/character/` - 모든 캐릭터 조회
- `GET /api/character/{id}` - 특정 캐릭터 조회
- `POST /api/character/` - 캐릭터 생성
- `PUT /api/character/{id}` - 캐릭터 수정
- `DELETE /api/character/{id}` - 캐릭터 삭제
- `GET /api/character/location/{location_id}` - 장소별 캐릭터 조회

### 채팅
- `POST /api/chat/location/{location_id}` - 멀티 캐릭터 채팅 ⭐
- `GET /api/chat/session/{session_id}/history` - 대화 히스토리 조회
- `DELETE /api/chat/session/{session_id}` - 대화 히스토리 초기화

### 오프닝
- `GET /api/opening/scenarios` - 오프닝 시나리오 목록 ⭐
- `POST /api/opening/start` - 게임 시작 (시나리오 선택) ⭐

---

## 🗄️ 데이터베이스 스키마

### characters 테이블
```sql
CREATE TABLE characters (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    location TEXT,
    personality TEXT,
    speech_style TEXT,
    background TEXT,
    ...
);
```

### locations 테이블
```sql
CREATE TABLE locations (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    ...
);
```

### relationships 테이블
```sql
CREATE TABLE relationships (
    user_id TEXT,
    character_id TEXT,
    intimacy REAL,
    dominance_score REAL,
    emotional_stats TEXT,  -- JSON
    core_memories TEXT,    -- JSON
    trigger_keywords TEXT, -- JSON
    ...
    PRIMARY KEY (user_id, character_id)
);
```

---

## 🎨 프론트엔드 구조

```
index.html
│
├── 초기화
│   └── initializeChat()
│       ├── 채팅방 진입
│       ├── 시스템 메시지 표시
│       └── 오프닝 선택지 로드
│
├── 오프닝 선택
│   └── selectScenario()
│       ├── 선택지 버튼 숨기기
│       ├── POST /api/opening/start
│       └── startGame()
│
├── 채팅
│   └── sendMessage()
│       ├── POST /api/chat/location/{id}
│       ├── 응답 표시
│       └── 연쇄 반응 처리 ⭐
│
└── UI 업데이트
    ├── addMessage()
    ├── updateCharactersInfo()
    └── showError()
```

---

## 📊 주요 개선 사항 요약

### ✅ 최적화 (Optimization)
- `utils/` 모듈 추가: 공통 코드 모듈화
- 중복 코드 제거: 약 40줄 감소
- Gemini API 클라이언트 통합

### ✅ UX 개선
- 오프닝 UX: 팝업 → 인-앱 선택지
- 채팅방 즉시 진입
- 시스템 메시지 표시

### ✅ 기능 추가
- 멀티 캐릭터 채팅: `chat_multi.py`
- 연쇄 반응: NPC 간 자동 상호작용
- 오프닝 시나리오: `opening.py`
- Speaker Selector: 지능형 화자 선택

---

## 🚀 실행 흐름

1. **서버 시작** (`main.py`)
   - DB 초기화
   - 라우터 등록
   - 정적 파일 마운트

2. **유저 접속** (`index.html`)
   - 채팅방 진입
   - 오프닝 선택지 표시

3. **게임 시작** (`opening.py`)
   - 시나리오 선택
   - 장소 설정
   - 첫 대사 표시

4. **채팅 진행** (`chat_multi.py`)
   - 화자 선택
   - 응답 생성
   - 연쇄 반응 처리
   - 데이터 업데이트

---

## 📝 참고 문서

- `DEVELOPER_GUIDE.md` - 기본 개발 가이드
- `SYSTEM_FLOW.md` - 시스템 플로우 상세
- `OPTIMIZATION_SUMMARY.md` - 최적화 요약
- `UX_IMPROVEMENTS.md` - UX 개선 사항
- `RELATIONSHIP_DATA_COMPLETE.md` - 관계 데이터 통합

---

**마지막 업데이트**: 2024년  
**버전**: 2.0 (멀티 캐릭터 + 연쇄 반응 + 최적화)
