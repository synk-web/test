# ëŒ€í™” ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

## ğŸ“ ëŒ€í™” ê´€ë ¨ í•µì‹¬ íŒŒì¼

### 1. API ë ˆì´ì–´
- **`api/chat_multi.py`** - ë©”ì¸ ì±„íŒ… API ì—”ë“œí¬ì¸íŠ¸
  - ìœ ì € ë©”ì‹œì§€ ìˆ˜ì‹ 
  - ì”¬ ë¦¬ì•¡ì…˜ ì‹œìŠ¤í…œ í˜¸ì¶œ
  - ì‘ë‹µ êµ¬ì„± ë° ë°˜í™˜

### 2. ëŒ€í™” ë¡œì§ ë ˆì´ì–´
- **`core/scene_reaction.py`** - ì”¬ ë¦¬ì•¡ì…˜ ì‹œìŠ¤í…œ (í•µì‹¬)
  - ë°˜ì‘ ë²”ìœ„ ë¶„ì„ ("ëª¨ë‘", "ë‹¤ë“¤" ê°ì§€)
  - ìºë¦­í„°ë³„ ë°˜ì‘ íƒ€ì… ê²°ì • (main/reaction/ignore)
  - ë©”ì¸ ì‘ë‹µ ìƒì„±
  - ì„œë¸Œ ë¦¬ì•¡ì…˜ ìƒì„±

- **`core/speaker_selector.py`** - í™”ì ì„ íƒ ë¡œì§
  - ì§ì ‘ í˜¸ëª… ê°ì§€
  - ëŒ€ëª…ì‚¬ ì²˜ë¦¬ ("ë„Œ", "ë„ˆ" â†’ ì§ì „ í™”ì)
  - Scene Context ê¸°ë°˜ ì„ íƒ
  - ëŒ€í™” íˆìŠ¤í† ë¦¬ ê´€ë¦¬

### 3. ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬ ë ˆì´ì–´
- **`core/scene_manager.py`** - ì”¬ ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬
  - Scene Context ìƒì„±/ì¡°íšŒ
  - ìºë¦­í„° ìƒíƒœ ì—…ë°ì´íŠ¸
  - ìµœê·¼ ì´ë²¤íŠ¸ ì¶”ì 
  - ìŠ¤í† ë¦¬ ì•„í¬ ê´€ë¦¬

- **`models/scene_context.py`** - ì”¬ ì»¨í…ìŠ¤íŠ¸ ëª¨ë¸
  - SceneContext í´ë˜ìŠ¤
  - CharacterState í´ë˜ìŠ¤
  - RecentEvent í´ë˜ìŠ¤

### 4. í”„ë¡¬í”„íŠ¸ ìƒì„± ë ˆì´ì–´
- **`core/prompt_builder_v2.py`** - í”„ë¡¬í”„íŠ¸ ë¹Œë”
  - ê´€ê³„ ë°ì´í„° í”„ë¡¬í”„íŠ¸
  - ë©€í‹° ìºë¦­í„° ì»¨í…ìŠ¤íŠ¸
  - í•µì‹¬ ê¸°ì–µ/íŠ¸ë¦¬ê±° í¬ë§·íŒ…

### 5. ë°ì´í„° ìˆ˜ì§‘ ë ˆì´ì–´
- **`core/data_collector.py`** - í„´ ë°ì´í„° ìˆ˜ì§‘
  - ê´€ê³„ ë°ì´í„° ì—…ë°ì´íŠ¸
  - ê°ì • í†µê³„ ì—…ë°ì´íŠ¸
  - í•µì‹¬ ê¸°ì–µ ìƒì„±
  - íŠ¸ë¦¬ê±° í‚¤ì›Œë“œ ë“±ë¡

---

## ğŸ”„ ëŒ€í™” íë¦„ (ì „ì²´ í”„ë¡œì„¸ìŠ¤)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ìœ ì € ë©”ì‹œì§€ ì…ë ¥                                          â”‚
â”‚    POST /api/chat/location/{location_id}                   â”‚
â”‚    { user_id, location_id, message, session_id }            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ê¸°ë³¸ ê²€ì¦ (api/chat_multi.py)                            â”‚
â”‚    - ì¥ì†Œ í™•ì¸                                               â”‚
â”‚    - ìºë¦­í„° ì¡°íšŒ                                             â”‚
â”‚    - ì„¸ì…˜ ID ìƒì„±/ì¡°íšŒ                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Scene Context ì¡°íšŒ/ìƒì„± (scene_manager)                  â”‚
â”‚    - ì„¸ì…˜ë³„ ì”¬ ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬                                 â”‚
â”‚    - ìºë¦­í„° ìƒíƒœ ì¶”ì                                         â”‚
â”‚    - ìµœê·¼ ì´ë²¤íŠ¸ ê¸°ë¡                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ëŒ€í™” íˆìŠ¤í† ë¦¬ ì¶”ê°€ (speaker_selector.ConversationHistory)â”‚
â”‚    - ìœ ì € ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€                             â”‚
â”‚    - ìµœê·¼ í„´ ì¶”ì                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ì”¬ ë¦¬ì•¡ì…˜ ìƒì„± (scene_reaction.generate_scene_reaction)  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚ 5-1. ë°˜ì‘ ë²”ìœ„ ë¶„ì„                                  â”‚  â”‚
â”‚    â”‚      - "ëª¨ë‘", "ë‹¤ë“¤" ê°ì§€ â†’ "all"                  â”‚  â”‚
â”‚    â”‚      - íŠ¹ì • ê·¸ë£¹ ê°ì§€ â†’ "group"                      â”‚  â”‚
â”‚    â”‚      - ê¸°ë³¸ê°’ â†’ "selective"                         â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚ 5-2. ìºë¦­í„°ë³„ ë°˜ì‘ íƒ€ì… ê²°ì •                         â”‚  â”‚
â”‚    â”‚      - ì§ì ‘ í˜¸ëª… â†’ "main"                           â”‚  â”‚
â”‚    â”‚      - "ëª¨ë‘" íŠ¸ë¦¬ê±° + recent â†’ "main"               â”‚  â”‚
â”‚    â”‚      - "ëª¨ë‘" íŠ¸ë¦¬ê±° + ì¼ë°˜ â†’ "reaction"             â”‚  â”‚
â”‚    â”‚      - ê´€ì‹¬ ì—†ìŒ â†’ "ignore"                          â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚ 5-3. ë©”ì¸ ì‘ë‹µ ìƒì„± (main íƒ€ì… ìºë¦­í„°ë“¤)             â”‚  â”‚
â”‚    â”‚      - í”„ë¡¬í”„íŠ¸ êµ¬ì„±                                  â”‚  â”‚
â”‚    â”‚      - Gemini API í˜¸ì¶œ                               â”‚  â”‚
â”‚    â”‚      - ì†ë§ˆìŒ ìƒì„±                                    â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚ 5-4. ì„œë¸Œ ë¦¬ì•¡ì…˜ ìƒì„± (reaction íƒ€ì… ìºë¦­í„°ë“¤)       â”‚  â”‚
â”‚    â”‚      - ì§§ì€ í”„ë¡¬í”„íŠ¸ (1~2ë¬¸ì¥)                       â”‚  â”‚
â”‚    â”‚      - Gemini API í˜¸ì¶œ                               â”‚  â”‚
â”‚    â”‚      - ì†ë§ˆìŒ ìƒì„±                                    â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚ 5-5. ë¬´ë°˜ì‘ ìºë¦­í„° (ignore íƒ€ì…)                     â”‚  â”‚
â”‚    â”‚      - ì†ë§ˆìŒë§Œ ìƒì„±                                  â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Scene Context ì—…ë°ì´íŠ¸ (scene_manager)                   â”‚
â”‚    - ë©”ì¸ ì‘ë‹µìë“¤ì˜ ìƒíƒœ ì—…ë°ì´íŠ¸                           â”‚
â”‚    - last_speaker ê°±ì‹                                       â”‚
â”‚    - ìµœê·¼ ì´ë²¤íŠ¸ ì¶”ê°€                                        â”‚
â”‚    - ìºë¦­í„° ìƒíƒœ ì—…ë°ì´íŠ¸                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. ë°ì´í„° ìˆ˜ì§‘ (data_collector.process_turn)                â”‚
â”‚    - ê´€ê³„ ë°ì´í„° ì—…ë°ì´íŠ¸ (ì¹œë°€ë„, ì§€ë°°ë ¥)                   â”‚
â”‚    - ê°ì • í†µê³„ ì—…ë°ì´íŠ¸                                      â”‚
â”‚    - í•µì‹¬ ê¸°ì–µ ìƒì„± (ì¡°ê±´ë¶€)                                 â”‚
â”‚    - íŠ¸ë¦¬ê±° í‚¤ì›Œë“œ ë“±ë¡ (ì¡°ê±´ë¶€)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. ì‘ë‹µ êµ¬ì„± ë° ë°˜í™˜                                         â”‚
â”‚    {                                                         â”‚
â”‚      "main_responses": [...],                               â”‚
â”‚      "sub_reactions": [...],                                â”‚
â”‚      "no_reaction": [...],                                  â”‚
â”‚      "scene_context": {...}                                  â”‚
â”‚    }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ì”¬ ë¦¬ì•¡ì…˜ ì‹œìŠ¤í…œ ìƒì„¸

### ë°˜ì‘ íƒ€ì… ê²°ì • ë¡œì§

```python
def determine_reaction_type(
    character: CharacterPersona,
    character_id: str,
    scene_context: Optional[SceneContext],
    user_message: str,
    reaction_scope: str,  # "all" | "group" | "selective"
    directly_mentioned: bool
) -> str:
    """
    Returns:
        "main" - ë©”ì¸ ì‘ë‹µì (ê¸´ ëŒ€ì‚¬)
        "reaction" - ì„œë¸Œ ë¦¬ì•¡ì…˜ (ì§§ì€ ë°˜ì‘)
        "ignore" - ë¬´ë°˜ì‘ (ì†ë§ˆìŒë§Œ)
    """
    
    # 1. ì§ì ‘ í˜¸ëª… â†’ ë¬´ì¡°ê±´ main
    if directly_mentioned:
        return "main"
    
    # 2. "ëª¨ë‘" íŠ¸ë¦¬ê±°
    if reaction_scope == "all":
        if scene_context and character_id in scene_context.character_states:
            state = scene_context.character_states[character_id]
            if state.recent:  # ìµœê·¼ ëŒ€í™” ì°¸ì—¬ì
                return "main"
        return "reaction"  # ë‚˜ë¨¸ì§€ëŠ” reaction
    
    # 3. ê´€ì‹¬ ì—†ìŒ â†’ ignore
    if scene_context and character_id in scene_context.character_states:
        state = scene_context.character_states[character_id]
        if state.attention == CharacterAttention.NONE:
            return "ignore"
    
    # 4. ê¸°ë³¸ê°’: reaction
    return "reaction"
```

### ë°˜ì‘ ë²”ìœ„ ë¶„ì„

```python
FULL_REACTION_TRIGGERS = [
    "ëª¨ë‘", "ë‹¤ë“¤", "ì—¬ê¸° ìˆëŠ” ì‚¬ëŒë“¤", "ì „ë¶€",
    "ë„ˆí¬ë“¤", "ë‹ˆë“¤", "ì•¼ ë‹¤ë“¤", "ëª¨ë‘ì—ê²Œ", "ë‹¤ë“¤ì—ê²Œ"
]

def analyze_reaction_scope(user_message: str) -> str:
    """
    "ëª¨ë‘ ë‚˜ë¥¼ ëŒ€ì¥ì´ë¼ê³  ë¶ˆëŸ¬ë¼" â†’ "all"
    "ë‚¨ìë“¤ë§Œ ì™€ë´" â†’ "group"
    "ì£¼ì°½ìœ¤ ë­í•´?" â†’ "selective"
    """
```

---

## ğŸ“Š ë°ì´í„° êµ¬ì¡°

### 1. Scene Context êµ¬ì¡°

```python
class SceneContext:
    location: str                    # í˜„ì¬ ì¥ì†Œ
    tension: int                    # ê¸´ì¥ë„
    current_focus: str              # í˜„ì¬ ëŒ€í™” í¬ì»¤ìŠ¤
    last_speaker_id: str            # ë§ˆì§€ë§‰ í™”ì ID
    last_speaker_name: str          # ë§ˆì§€ë§‰ í™”ì ì´ë¦„
    character_states: Dict[str, CharacterState]  # ìºë¦­í„°ë³„ ìƒíƒœ
    recent_events: List[RecentEvent] # ìµœê·¼ ì´ë²¤íŠ¸
    story_arc: List[str]            # ìŠ¤í† ë¦¬ ì•„í¬
```

### 2. Character State êµ¬ì¡°

```python
class CharacterState:
    character_name: str
    recent: bool                    # ìµœê·¼ ëŒ€í™” ì°¸ì—¬ ì—¬ë¶€
    attention: CharacterAttention   # USER | CHARACTER | OBSERVING | NONE
    attention_target: str           # ì£¼ì‹œ ëŒ€ìƒ
    mood: str                       # í˜„ì¬ ê¸°ë¶„
    inner_thought: Optional[str]    # ì†ë§ˆìŒ
```

### 3. ì‘ë‹µ êµ¬ì¡°

```python
class SceneReactionResult:
    main_responses: List[MainResponse]    # ë©”ì¸ ì‘ë‹µìë“¤
    sub_reactions: List[SubReaction]      # ì„œë¸Œ ë¦¬ì•¡ì…˜
    no_reaction: List[Dict]               # ë¬´ë°˜ì‘ ìºë¦­í„°

class MainResponse:
    character_id: str
    character_name: str
    message: str              # ê¸´ ëŒ€ì‚¬
    action: Optional[str]     # í–‰ë™ ë¬˜ì‚¬
    inner_thought: Optional[str]

class SubReaction:
    character_id: str
    character_name: str
    reaction: str             # ì§§ì€ ë°˜ì‘ (1~2ë¬¸ì¥)
    inner_thought: Optional[str]
```

---

## ğŸ” í™”ì ì„ íƒ ë¡œì§ (Speaker Selector)

### ìš°ì„ ìˆœìœ„

1. **ì§ì ‘ í˜¸ëª…** (ìµœìš°ì„ )
   - "ì£¼ì°½ìœ¤ ë­í•´?" â†’ ì£¼ì°½ìœ¤
   - "ì¸í•˜ì•¼" â†’ í™©ì¸í•˜ (ì• ì¹­ ê°ì§€)

2. **ëŒ€ëª…ì‚¬ ì²˜ë¦¬**
   - "ë„Œ ë­”ë°?" â†’ ì§ì „ í™”ì
   - "ë„ˆëŠ”?" â†’ ì§ì „ í™”ì

3. **ìœ ì € ì§‘ì¤‘ íŒ¨í„´**
   - "ì¸í•˜í•œí…Œ", "ì¸í•˜ì—ê²Œ" â†’ í™©ì¸í•˜

4. **ìœ ì € ì£¼ì‹œ ì¤‘ì¸ recent ìºë¦­í„°**
   - Scene Contextì—ì„œ ìœ ì €ë¥¼ ì£¼ì‹œí•˜ëŠ” ìºë¦­í„°

5. **ìµœê·¼ ëŒ€í™” ì°¸ì—¬ì**
   - recent íƒœê·¸ê°€ ìˆëŠ” ìºë¦­í„°

6. **ë§ˆì§€ë§‰ í™”ì ìœ ì§€**
   - Scene Contextì˜ last_speaker

7. **ëœë¤ ì„ íƒ** (ìµœí›„ì˜ ìˆ˜ë‹¨)

---

## ğŸ’¬ ëŒ€í™” ì˜ˆì‹œ

### ì˜ˆì‹œ 1: "ëª¨ë‘ì—ê²Œ" ë°œì–¸

```
ìœ ì €: "ì•ìœ¼ë¡œ ëª¨ë‘ ë‚˜ë¥¼ ëŒ€ì¥ì´ë¼ê³  ë¶ˆëŸ¬ë¼"

[ë°˜ì‘ ë²”ìœ„ ë¶„ì„]
â†’ "ëª¨ë‘" ê°ì§€ â†’ reaction_scope = "all"

[ìºë¦­í„°ë³„ ë°˜ì‘ íƒ€ì…]
- ì£¼ì°½ìœ¤ (recent=True) â†’ "main"
- ê³ ì„ í•˜ (recent=True) â†’ "main"
- í™©ì¸í•˜ (recent=False) â†’ "reaction"
- í‘œë‹¤ì€ (recent=False) â†’ "reaction"
- ë¯¼ì•„ë¦„ (attention=NONE) â†’ "ignore"

[ê²°ê³¼]
main_responses:
  - ì£¼ì°½ìœ¤: "í•˜... ëŒ€ì¥? ì›ƒê¸°ê³  ìˆë„¤. ë„¤ê¹Ÿ ë†ˆì´ ë­˜ í•  ìˆ˜ ìˆëŠ”ë°?"
  - ê³ ì„ í•˜: "ì–´ë¨¸, ëŒ€ì¥ì´ë¼ë‹ˆ. ì •ë§ ì²œë°•í•œ ë°œìƒì´ë„¤."

sub_reactions:
  - í™©ì¸í•˜: "*í¥ë¯¸ë¡­ë‹¤ëŠ” ë“¯ ì…ê¼¬ë¦¬ë¥¼ ì˜¬ë¦°ë‹¤*"
  - í‘œë‹¤ì€: "*ê±±ì •ìŠ¤ëŸ¬ìš´ í‘œì •ìœ¼ë¡œ ì§€ì¼œë³¸ë‹¤*"

no_reaction:
  - ë¯¼ì•„ë¦„: ğŸ’­ "ì‹œë„ëŸ¬ì›Œ... ëˆ„ê°€ ëŒ€ì¥ì´ë“  ìƒê´€ì—†ì–´..."
```

### ì˜ˆì‹œ 2: ì§ì ‘ í˜¸ëª…

```
ìœ ì €: "ì¸í•˜ì•¼ ë‚´ê°€ ë„ˆí•œí…Œ ì´ì•¼ê¸°í•˜ê³  ìˆì–ëƒ"

[ë°˜ì‘ ë²”ìœ„ ë¶„ì„]
â†’ "ì¸í•˜ì•¼" ê°ì§€ â†’ directly_mentioned = True

[ìºë¦­í„°ë³„ ë°˜ì‘ íƒ€ì…]
- í™©ì¸í•˜ â†’ "main" (ì§ì ‘ í˜¸ëª…)
- ë‚˜ë¨¸ì§€ â†’ "reaction" ë˜ëŠ” "ignore"

[ê²°ê³¼]
main_responses:
  - í™©ì¸í•˜: "í›„í›„... ë‚´ê°€ ì´ì•¼ê¸°í•˜ëŠ” ê²Œ ê·¸ë ‡ê²Œ ì‹ ê¸°í•œê°€? ê·¸ëŸ°ë°, ë„ˆ. í˜¹ì‹œ ë‚´ê°€ í•˜ëŠ” ë§, ì œëŒ€ë¡œ ì´í•´ëŠ” í•˜ê³  ìˆëŠ” ê±°ë‹ˆ?"

sub_reactions:
  - ì£¼ì°½ìœ¤: "*ì½”ì›ƒìŒ*"
  - í‘œë‹¤ì€: "*ì§€ì¼œë³¸ë‹¤*"
```

---

## ğŸ› ï¸ ì£¼ìš” í•¨ìˆ˜ ë° ì—­í• 

### api/chat_multi.py
- `chat_in_location()` - ë©”ì¸ API ì—”ë“œí¬ì¸íŠ¸

### core/scene_reaction.py
- `analyze_reaction_scope()` - ë°˜ì‘ ë²”ìœ„ ë¶„ì„
- `determine_reaction_type()` - ë°˜ì‘ íƒ€ì… ê²°ì •
- `generate_main_response()` - ë©”ì¸ ì‘ë‹µ ìƒì„±
- `generate_sub_reaction()` - ì„œë¸Œ ë¦¬ì•¡ì…˜ ìƒì„±
- `generate_scene_reaction()` - í†µí•© ìƒì„± í•¨ìˆ˜

### core/speaker_selector.py
- `select_speaker_v2()` - í™”ì ì„ íƒ (v2)
- `detect_mentioned_npc()` - NPC ì–¸ê¸‰ ê°ì§€
- `build_conversation_context()` - ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ ë¹Œë“œ
- `ConversationHistory` - ëŒ€í™” íˆìŠ¤í† ë¦¬ ê´€ë¦¬

### core/scene_manager.py
- `get_or_create_context()` - Scene Context ì¡°íšŒ/ìƒì„±
- `process_character_response()` - ìºë¦­í„° ì‘ë‹µ ì²˜ë¦¬
- `process_user_message()` - ìœ ì € ë©”ì‹œì§€ ì²˜ë¦¬

### core/prompt_builder_v2.py
- `build_relationship_context()` - ê´€ê³„ ë°ì´í„° í”„ë¡¬í”„íŠ¸
- `build_multi_character_context()` - ë©€í‹° ìºë¦­í„° ì»¨í…ìŠ¤íŠ¸

### core/data_collector.py
- `process_turn()` - í„´ ë°ì´í„° ìˆ˜ì§‘ ë° ê´€ê³„ ë°ì´í„° ì—…ë°ì´íŠ¸

---

## ğŸ“ˆ ì„±ëŠ¥ ë° ìµœì í™”

### í˜„ì¬ êµ¬ì¡°ì˜ ì¥ì 
1. **ëª¨ë“ˆí™”**: ê° ê¸°ëŠ¥ì´ ë…ë¦½ì ìœ¼ë¡œ ë¶„ë¦¬
2. **í™•ì¥ì„±**: ìƒˆë¡œìš´ ë°˜ì‘ íƒ€ì… ì¶”ê°€ ìš©ì´
3. **ìœ ì§€ë³´ìˆ˜ì„±**: ì½”ë“œê°€ ê°„ê²°í•˜ê³  ëª…í™•

### ê°œì„  ê°€ëŠ¥í•œ ë¶€ë¶„
1. **ë³‘ë ¬ ì²˜ë¦¬**: ì—¬ëŸ¬ ìºë¦­í„° ì‘ë‹µì„ ë™ì‹œì— ìƒì„±
2. **ìºì‹±**: Scene Context ìºì‹±
3. **ë°°ì¹˜ ì²˜ë¦¬**: ì—¬ëŸ¬ ì„œë¸Œ ë¦¬ì•¡ì…˜ì„ í•œ ë²ˆì— ìƒì„±

---

**ì‘ì„±ì¼**: 2024ë…„  
**ë²„ì „**: v2.1 (ì”¬ ë¦¬ì•¡ì…˜ ì‹œìŠ¤í…œ)
