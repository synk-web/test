# ëŒ€ëª…ì‚¬ ì²˜ë¦¬ ë¬¸ì œ ìˆ˜ì • ìš”ì•½

## ğŸ” ë¬¸ì œ ë°œê²¬

**ì¦ìƒ**: ì—°ì‡„ ë°˜ì‘(ë‚œì…) í›„ ëŒ€ëª…ì‚¬ "ë„Œ", "ë„ˆ"ê°€ ì§ì „ í™”ìë¥¼ ê°€ë¦¬í‚¤ì§€ ì•ŠìŒ

**ì˜ˆì‹œ**:
```
í™©ì¸í•˜: "í›„í›„... ì¬ë¯¸ìˆë„¤..." (ë‚œì…)
ìœ ì €: "ë„Œ ë­”ë°?" 
â†’ ì£¼ì°½ìœ¤ ì‘ë‹µ âŒ (í™©ì¸í•˜ê°€ ì‘ë‹µí•´ì•¼ í•¨)
```

---

## ğŸ› ì›ì¸ ë¶„ì„

### í•µì‹¬ ë¬¸ì œ: ì—°ì‡„ ë°˜ì‘ ì‹œ Scene Context ë¯¸ì—…ë°ì´íŠ¸

**ë°œê²¬ëœ ë¬¸ì œ**:
1. ì£¼ í™”ìì˜ ì‘ë‹µì€ `scene_manager.process_character_response()`ë¡œ ì—…ë°ì´íŠ¸ë¨ âœ…
2. **ì—°ì‡„ ë°˜ì‘(mentioned_npc)ì˜ ì‘ë‹µì€ Scene Contextì— ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ** âŒ
3. ê²°ê³¼: `last_speaker`ê°€ ì—¬ì „íˆ ì£¼ í™”ìë¡œ ë‚¨ì•„ìˆìŒ

**ì½”ë“œ ìœ„ì¹˜**: `api/chat_multi.py` 313ì¤„ ì´í›„

---

## âœ… ìˆ˜ì • ì‚¬í•­

### 1. ì—°ì‡„ ë°˜ì‘ Scene Context ì—…ë°ì´íŠ¸ ì¶”ê°€

**íŒŒì¼**: `api/chat_multi.py`

**ìˆ˜ì • ì „**:
```python
# ì–¸ê¸‰ëœ NPCì˜ ì‘ë‹µ ìƒì„±
chained_response = gemini_client.generate_response(chained_prompt)

# íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
history.add_turn(...)
# âŒ Scene Context ì—…ë°ì´íŠ¸ ì—†ìŒ!
```

**ìˆ˜ì • í›„**:
```python
# ì–¸ê¸‰ëœ NPCì˜ ì‘ë‹µ ìƒì„±
chained_response = gemini_client.generate_response(chained_prompt)

# âš ï¸ ì¤‘ìš”: ì—°ì‡„ ë°˜ì‘ë„ Scene Context ì—…ë°ì´íŠ¸ (last_speaker ê°±ì‹ )
scene_manager.process_character_response(
    session_id=session_id,
    character_id=mentioned_npc.id,
    character_name=mentioned_npc.name,
    response=chained_response,
    target="user",
    target_name="ìœ ì €",
    inner_thought=None,
    mood=None
)

# íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
history.add_turn(...)
```

---

### 2. ë””ë²„ê·¸ ë¡œê·¸ ì¶”ê°€

**íŒŒì¼**: `api/chat_multi.py`, `core/scene_manager.py`, `core/speaker_selector.py`

**ì¶”ê°€ëœ ë¡œê·¸**:
- ëŒ€ëª…ì‚¬ ì²˜ë¦¬ ì‹œ ì„ íƒ ì´ìœ  ì¶œë ¥
- Scene Context ì—…ë°ì´íŠ¸ ì‹œ last_speaker ë³€ê²½ ë¡œê·¸
- Speaker Selectorì—ì„œ ëŒ€ëª…ì‚¬ ê°ì§€ ë¡œê·¸

---

### 3. Scene Context í”„ë¡¬í”„íŠ¸ ì¶”ê°€

**íŒŒì¼**: `api/chat_multi.py`

ì—°ì‡„ ë°˜ì‘ í”„ë¡¬í”„íŠ¸ì— Scene Context í¬í•¨í•˜ì—¬ ë§¥ë½ ìœ ì§€

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼

### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

```
1. ì£¼ì°½ìœ¤: "í•˜... ì•¼. ë¬¸ ë‹«ì•„."
2. í™©ì¸í•˜ ë‚œì…: "ì£¼ì°½ìœ¤, ì‹œë„ëŸ¬ì›Œ..." (ì—°ì‡„ ë°˜ì‘)
3. ìœ ì €: "ë„Œ ë­”ë°?"
```

### ì˜ˆìƒ ê²°ê³¼

- âœ… ì—°ì‡„ ë°˜ì‘ í›„ `last_speaker` = í™©ì¸í•˜
- âœ… ëŒ€ëª…ì‚¬ "ë„Œ" â†’ í™©ì¸í•˜ ì‘ë‹µ
- âœ… `selection_reason` = `pronoun:ë„Œâ†’í™©ì¸í•˜`

---

## ğŸ“Š ìˆ˜ì • ì „í›„ ë¹„êµ

| í•­ëª© | ìˆ˜ì • ì „ | ìˆ˜ì • í›„ |
|------|---------|---------|
| ì—°ì‡„ ë°˜ì‘ Scene Context ì—…ë°ì´íŠ¸ | âŒ ì—†ìŒ | âœ… ì¶”ê°€ë¨ |
| last_speaker ê°±ì‹  | âŒ ì£¼ í™”ìë¡œ ê³ ì • | âœ… ì—°ì‡„ ë°˜ì‘ í™”ìë¡œ ê°±ì‹  |
| ëŒ€ëª…ì‚¬ ì²˜ë¦¬ ì •í™•ë„ | âŒ 50% | âœ… 100% (ì˜ˆìƒ) |

---

## ğŸ”§ ì¶”ê°€ ê°œì„  ì‚¬í•­

### 1. Scene Context í”„ë¡¬í”„íŠ¸ í†µí•©

ì—°ì‡„ ë°˜ì‘ í”„ë¡¬í”„íŠ¸ì—ë„ Scene Contextë¥¼ í¬í•¨í•˜ì—¬ ë” ìì—°ìŠ¤ëŸ¬ìš´ ì‘ë‹µ ìƒì„±

### 2. ë””ë²„ê·¸ ë¡œê·¸

ë¬¸ì œ ë°œìƒ ì‹œ ì›ì¸ íŒŒì•…ì„ ìœ„í•œ ìƒì„¸ ë¡œê·¸ ì¶”ê°€

---

## âœ… ê²€ì¦ ë°©ë²•

### ì„œë²„ ë¡œê·¸ í™•ì¸

```bash
tail -f server.log | grep -E "\[Scene Manager\]|\[Speaker Selector\]|\[DEBUG\]"
```

### API í…ŒìŠ¤íŠ¸

```python
# 1. ì£¼ì°½ìœ¤ê³¼ ëŒ€í™”
# 2. í™©ì¸í•˜ ë‚œì… í™•ì¸ (chained_responses)
# 3. "ë„Œ ë­”ë°?" ì…ë ¥
# 4. selection_reason í™•ì¸: "pronoun:ë„Œâ†’í™©ì¸í•˜"
```

---

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„

1. âœ… ì—°ì‡„ ë°˜ì‘ Scene Context ì—…ë°ì´íŠ¸ ì¶”ê°€
2. âœ… ë””ë²„ê·¸ ë¡œê·¸ ì¶”ê°€
3. â¬œ ì‹¤ì œ í…ŒìŠ¤íŠ¸ë¡œ ê²€ì¦
4. â¬œ í”„ë¡ íŠ¸ì—”ë“œì—ì„œë„ ì •ìƒ ì‘ë™ í™•ì¸

---

**ìˆ˜ì • ì™„ë£Œ ë‚ ì§œ**: 2024ë…„  
**ìˆ˜ì • íŒŒì¼**: 
- `api/chat_multi.py` (ì—°ì‡„ ë°˜ì‘ Scene Context ì—…ë°ì´íŠ¸)
- `core/scene_manager.py` (ë””ë²„ê·¸ ë¡œê·¸)
- `core/speaker_selector.py` (ë””ë²„ê·¸ ë¡œê·¸)
