# SYNK MVP v2.1 ì½”ë“œ êµ¬ì¡°

## ğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
v0/
â”œâ”€â”€ api/                          # API ì—”ë“œí¬ì¸íŠ¸
â”‚   â”œâ”€â”€ character_api.py         # ìºë¦­í„° CRUD
â”‚   â”œâ”€â”€ chat_multi.py            # ë©€í‹° ìºë¦­í„° ì±„íŒ… (Scene Context í†µí•©)
â”‚   â”œâ”€â”€ opening.py               # ì˜¤í”„ë‹ ì‹œë‚˜ë¦¬ì˜¤
â”‚   â”œâ”€â”€ reaction.py              # ì´ëª¨ì§€ ë¦¬ì•¡ì…˜
â”‚   â””â”€â”€ user_profile.py          # ìœ ì € í”„ë¡œí•„
â”‚
â”œâ”€â”€ core/                         # í•µì‹¬ ë¡œì§
â”‚   â”œâ”€â”€ data_collector.py        # ë°ì´í„° ìˆ˜ì§‘ ë° ê´€ê³„ ì—…ë°ì´íŠ¸
â”‚   â”œâ”€â”€ dominance_calc.py        # Dominance ê³„ì‚°
â”‚   â”œâ”€â”€ emotion_analyzer.py       # ê°ì • ë¶„ì„
â”‚   â”œâ”€â”€ inner_thought_generator.py  # ì†ë§ˆìŒ ìƒì„±
â”‚   â”œâ”€â”€ memory_manager.py        # í•µì‹¬ ê¸°ì–µ ê´€ë¦¬
â”‚   â”œâ”€â”€ prompt_builder_v2.py     # í”„ë¡¬í”„íŠ¸ ë¹Œë”
â”‚   â”œâ”€â”€ scene_manager.py         # Scene Context ê´€ë¦¬ (v2.1) â­
â”‚   â”œâ”€â”€ speaker_selector.py      # í™”ì ì„ íƒ (ëŒ€ëª…ì‚¬ ì²˜ë¦¬ ê°œì„ ) â­
â”‚   â”œâ”€â”€ trigger_detector.py      # íŠ¸ë¦¬ê±° í‚¤ì›Œë“œ ê°ì§€
â”‚   â”œâ”€â”€ user_profile_extractor.py  # ìœ ì € ì •ë³´ ì¶”ì¶œ
â”‚   â””â”€â”€ tiki_taka.py             # í‹°í‚¤íƒ€ì¹´ ì‹œìŠ¤í…œ (ì¤€ë¹„ë¨)
â”‚
â”œâ”€â”€ db/                           # ë°ì´í„°ë² ì´ìŠ¤
â”‚   â”œâ”€â”€ character_db.py          # ìºë¦­í„° DB
â”‚   â”œâ”€â”€ database.py              # ê´€ê³„ ë°ì´í„° DB
â”‚   â””â”€â”€ user_profile_db.py       # ìœ ì € í”„ë¡œí•„ DB
â”‚
â”œâ”€â”€ models/                       # ë°ì´í„° ëª¨ë¸
â”‚   â”œâ”€â”€ character.py             # CharacterPersona, Location
â”‚   â”œâ”€â”€ inner_thought.py         # InnerThought
â”‚   â”œâ”€â”€ relationship.py          # RelationshipData
â”‚   â”œâ”€â”€ scene_context.py         # Scene Context (v2.1) â­
â”‚   â””â”€â”€ user_profile.py          # UserProfile
â”‚
â”œâ”€â”€ static/                       # í”„ë¡ íŠ¸ì—”ë“œ
â”‚   â””â”€â”€ index.html               # ì±„íŒ… UI (Scene Dashboard í¬í•¨)
â”‚
â”œâ”€â”€ utils/                        # ìœ í‹¸ë¦¬í‹°
â”‚   â”œâ”€â”€ config.py                # í™˜ê²½ ì„¤ì •
â”‚   â””â”€â”€ gemini_client.py         # Gemini API í´ë¼ì´ì–¸íŠ¸
â”‚
â””â”€â”€ main.py                       # ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜
```

---

## ğŸ”„ í•µì‹¬ ë°ì´í„° íë¦„

### 1. ìœ ì € ë©”ì‹œì§€ ì²˜ë¦¬

```
ìœ ì € ë©”ì‹œì§€ ì…ë ¥
    â”‚
    â–¼
Scene Manager.process_user_message()
    â”œâ”€â†’ ëŒ€ëª…ì‚¬ ì²´í¬ ("ë„Œ", "ë„ˆ")
    â”œâ”€â†’ ìµœê·¼ í™”ì í™•ì¸
    â””â”€â†’ ìœ ì € ì£¼ì‹œ ì¤‘ì¸ ìºë¦­í„° í™•ì¸
    â”‚
    â–¼
Speaker Selector v2.select_speaker_v2()
    â”œâ”€â†’ ì§ì ‘ ì´ë¦„ ë©˜ì…˜
    â”œâ”€â†’ @ ë©˜ì…˜
    â”œâ”€â†’ ëŒ€ëª…ì‚¬ â†’ ì§ì „ í™”ì
    â”œâ”€â†’ ìµœê·¼ ëŒ€í™” ì°¸ì—¬ì
    â””â”€â†’ ìœ ì € ì£¼ì‹œ ì¤‘ì¸ ìºë¦­í„°
    â”‚
    â–¼
ìºë¦­í„° ì„ íƒ ì™„ë£Œ
```

### 2. ìºë¦­í„° ì‘ë‹µ ìƒì„±

```
ì„ íƒëœ ìºë¦­í„°
    â”‚
    â–¼
í”„ë¡¬í”„íŠ¸ ìƒì„±
    â”œâ”€â†’ ìºë¦­í„° í˜ë¥´ì†Œë‚˜
    â”œâ”€â†’ ê´€ê³„ ë°ì´í„°
    â”œâ”€â†’ Scene Context â­ (v2.1)
    â”œâ”€â†’ ë©€í‹° ìºë¦­í„° ì»¨í…ìŠ¤íŠ¸
    â””â”€â†’ ëŒ€í™” íˆìŠ¤í† ë¦¬
    â”‚
    â–¼
Gemini API í˜¸ì¶œ
    â”‚
    â–¼
ìºë¦­í„° ì‘ë‹µ ìƒì„±
```

### 3. Scene Context ì—…ë°ì´íŠ¸

```
ìºë¦­í„° ì‘ë‹µ
    â”‚
    â–¼
Scene Manager.process_character_response()
    â”œâ”€â†’ RecentEvent ì¶”ê°€
    â”œâ”€â†’ CharacterState ì—…ë°ì´íŠ¸
    â”œâ”€â†’ last_speaker ì—…ë°ì´íŠ¸
    â””â”€â†’ current_focus ì—…ë°ì´íŠ¸
    â”‚
    â–¼
í”„ë¡ íŠ¸ì—”ë“œ ì—…ë°ì´íŠ¸
    â”œâ”€â†’ Scene Dashboard ì—…ë°ì´íŠ¸
    â””â”€â†’ ìºë¦­í„° ìƒíƒœ í‘œì‹œ
```

---

## ğŸ¯ í•µì‹¬ ëª¨ë“ˆ ì„¤ëª…

### Scene Context (`models/scene_context.py`)

**ì—­í• **: ëª¨ë“  ìºë¦­í„°ê°€ ê³µìœ í•˜ëŠ” í˜„ì¬ ìƒí™©

**ì£¼ìš” êµ¬ì„±ìš”ì†Œ:**
- `Story Arc`: ì „ì²´ ìŠ¤í† ë¦¬ íë¦„ (ìµœê·¼ 20ê°œ)
- `Recent Events`: ìµœê·¼ ëŒ€í™” ë§¥ë½ (ìµœê·¼ 10ê°œ)
- `Character States`: ìºë¦­í„°ë³„ ìƒíƒœ
- `Conversation Focus`: í˜„ì¬ ëŒ€í™” í¬ì»¤ìŠ¤
- `Scene Atmosphere`: ë¶„ìœ„ê¸° ë° ê¸´ì¥ë„

**ì‚¬ìš©ì²˜:**
- í”„ë¡¬í”„íŠ¸ì— ì£¼ì… (ë§¥ë½ ìœ ì§€)
- í™”ì ì„ íƒ ë¡œì§
- í”„ë¡ íŠ¸ì—”ë“œ Dashboard

### Scene Manager (`core/scene_manager.py`)

**ì—­í• **: ì”¬ ìƒíƒœ ê´€ë¦¬ ë° ì—…ë°ì´íŠ¸

**ì£¼ìš” ê¸°ëŠ¥:**
- `get_or_create_context()`: ì”¬ ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ/ìƒì„±
- `process_user_message()`: ìœ ì € ë©”ì‹œì§€ ë¶„ì„
- `process_character_response()`: ìºë¦­í„° ì‘ë‹µ ì²˜ë¦¬

**ì‹±ê¸€í†¤ íŒ¨í„´**: ì „ì—­ ì¸ìŠ¤í„´ìŠ¤ `scene_manager`

### Speaker Selector v2 (`core/speaker_selector.py`)

**ì—­í• **: ê°œì„ ëœ í™”ì ì„ íƒ ë¡œì§

**ì„ íƒ ìš°ì„ ìˆœìœ„:**
1. ì§ì ‘ ì´ë¦„ ë©˜ì…˜
2. @ ë©˜ì…˜
3. ëŒ€ëª…ì‚¬ â†’ ì§ì „ í™”ì â­
4. ìµœê·¼ ëŒ€í™” ì°¸ì—¬ì
5. ìœ ì € ì£¼ì‹œ ì¤‘ì¸ ìºë¦­í„°
6. í™œì„± ìºë¦­í„° ì¤‘ ëœë¤

**í•µì‹¬ ê°œì„ :**
- ëŒ€ëª…ì‚¬ ì²˜ë¦¬ ì¶”ê°€
- Scene Context ê¸°ë°˜ ì„ íƒ
- ì„ íƒ ì´ìœ  ë°˜í™˜ (`selection_reason`)

---

## ğŸ”§ ì½”ë“œ ìµœì í™”

### ëª¨ë“ˆí™” ì›ì¹™

1. **ë‹¨ì¼ ì±…ì„ ì›ì¹™**: ê° ëª¨ë“ˆì€ í•˜ë‚˜ì˜ ì±…ì„ë§Œ
2. **ì˜ì¡´ì„± ì—­ì „**: ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ ì„¤ê³„
3. **ì¬ì‚¬ìš©ì„±**: ê³µí†µ ë¡œì§ì€ ìœ í‹¸ë¦¬í‹°ë¡œ ë¶„ë¦¬

### ì¤‘ë³µ ì œê±°

- âœ… Scene Contextë¥¼ í”„ë¡¬í”„íŠ¸, UI, APIì— ê³µí†µ ì‚¬ìš©
- âœ… Scene Manager ì‹±ê¸€í†¤ìœ¼ë¡œ ì „ì—­ ìƒíƒœ ê´€ë¦¬
- âœ… Speaker Selector v2ë¡œ ê¸°ì¡´ ë¡œì§ ê°œì„ 

### íš¨ìœ¨ì„±

- âœ… ë”•ì…”ë„ˆë¦¬ ê¸°ë°˜ ë¹ ë¥¸ ì¡°íšŒ
- âœ… ìµœê·¼ ì´ë²¤íŠ¸ë§Œ ìœ ì§€ (ë©”ëª¨ë¦¬ íš¨ìœ¨)
- âœ… Scene Context ìºì‹± (ì„¸ì…˜ë³„)

---

## ğŸ“Š API ì‘ë‹µ êµ¬ì¡°

### MultiChatResponse (v2.1)

```json
{
  "turn_id": "uuid",
  "session_id": "session_id",
  "character_id": "npc_joo_changyun",
  "character_name": "ì£¼ì°½ìœ¤",
  "character_response": "ëŒ€ì‚¬...",
  "location": "ë² íƒ€_ë™_ë¡œë¹„",
  "all_characters": [...],
  "conversation_turn": 3,
  "relationship_summary": {...},
  "chained_responses": [...],
  "inner_thought": {...},
  "scene_context": {              // â­ v2.1
    "location": "ë² íƒ€_ë™_ë¡œë¹„",
    "tension_level": 7,
    "atmosphere": "hostile",
    "current_focus": "ìœ ì €ì™€ ì£¼ì°½ìœ¤ì˜ ëŒ€í™”",
    "last_speaker_name": "ì£¼ì°½ìœ¤",
    "story_arc": [...],
    "character_states": {...}
  },
  "selection_reason": "pronoun:ë„Œâ†’ì£¼ì°½ìœ¤"  // â­ v2.1
}
```

---

## ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ êµ¬ì¡°

### Scene Dashboard

- **ìœ„ì¹˜**: ì±„íŒ… ì˜ì—­ ìƒë‹¨
- **í‘œì‹œ ë‚´ìš©**:
  - í˜„ì¬ ì¥ì†Œ
  - ê¸´ì¥ë„ ë°”
  - ìŠ¤í† ë¦¬ ìš”ì•½
  - ìºë¦­í„° ìƒíƒœ ì¹´ë“œ
  - í˜„ì¬ ëŒ€í™” í¬ì»¤ìŠ¤

### ì´ëª¨ì§€ ë¦¬ì•¡ì…˜

- **ìœ„ì¹˜**: ê° ìºë¦­í„° ëŒ€ì‚¬ ì•„ë˜
- **ë²„íŠ¼**: â¤ï¸ ğŸ’¢ ğŸ”¥ â­
- **ë™ì‘**: í´ë¦­ ì‹œ ì¦‰ì‹œ API í˜¸ì¶œ ë° ê´€ê³„ ë°ì´í„° ì—…ë°ì´íŠ¸

---

## âœ… ê²€ì¦ ì™„ë£Œ

- âœ… ëª¨ë“  ëª¨ë“ˆ ì •ìƒ ë¡œë“œ
- âœ… ë¦°í„° ì˜¤ë¥˜ ì—†ìŒ
- âœ… íƒ€ì… íŒíŒ… ì™„ì „ ì ìš©
- âœ… Scene Context í†µí•© ì™„ë£Œ
- âœ… Speaker Selector v2 ë™ì‘ í™•ì¸

---

**êµ¬ì¡° ë²„ì „**: v2.1  
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2024ë…„
