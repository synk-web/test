# 🏗️ SYNK MVP 시스템 아키텍처 시각화

> **최종 업데이트**: 2024년
> **버전**: v2.1

---

## 📖 일반인을 위한 가이드

이 문서는 **SYNK MVP**라는 AI 캐릭터 채팅 시스템이 어떻게 작동하는지 설명합니다.

### 🎯 이 시스템이 하는 일

**SYNK MVP**는 여러 AI 캐릭터와 동시에 대화할 수 있는 채팅 시스템입니다. 마치 게임 속 캐릭터들과 대화하는 것처럼, 여러 캐릭터가 상황에 맞게 반응하고, 관계가 발전하며, 스토리가 진행됩니다.

### 🔑 핵심 개념 (비유로 이해하기)

1. **API (애플리케이션 프로그래밍 인터페이스)**
   - **비유**: 레스토랑의 주문 창구
   - **역할**: 클라이언트가 서버에 요청을 보내는 창구

2. **데이터베이스 (DB)**
   - **비유**: 도서관의 책장
   - **역할**: 정보를 저장하고 꺼내는 창고

3. **Core 로직**
   - **비유**: 레스토랑의 주방
   - **역할**: 실제로 일을 처리하는 두뇌 부분

4. **프롬프트**
   - **비유**: AI에게 줄 숙제 문제
   - **역할**: AI가 무엇을 해야 할지 알려주는 지시문

5. **씬 컨텍스트**
   - **비유**: 대화의 맥락을 기억하는 뇌의 해마
   - **역할**: 현재 상황을 기억해서 일관성 있는 대화 유지

### 📚 문서 읽는 방법

- **기술자**: 모든 섹션을 읽으세요. 코드와 구조를 이해할 수 있습니다.
- **일반인**: 각 섹션의 "역할"과 "비유" 부분을 읽으세요. 시스템이 무엇을 하는지 이해할 수 있습니다.
- **기획자**: "핵심 기능 흐름" 섹션을 중점적으로 읽으세요. 시스템이 어떻게 작동하는지 파악할 수 있습니다.

---

## 📋 목차

1. [전체 시스템 구조](#1-전체-시스템-구조)
2. [데이터 흐름도](#2-데이터-흐름도)
3. [주요 컴포넌트](#3-주요-컴포넌트)
4. [API 엔드포인트](#4-api-엔드포인트)
5. [데이터베이스 구조](#5-데이터베이스-구조)
6. [핵심 기능 흐름](#6-핵심-기능-흐름)
7. [주요 기능 상세](#7-주요-기능-상세)

---

## 1. 전체 시스템 구조

> **시스템 구조란?** 전체 프로그램이 어떻게 구성되어 있는지 보여주는 설계도입니다. 마치 건물의 구조도처럼, 각 층이 무엇을 하는지 보여줍니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                    🖥️ 클라이언트 (브라우저)                        │
│                    static/index.html (Frontend)                  │
│                                                                  │
│  역할: 사용자가 보는 화면 (UI)                                    │
│  - 채팅 UI: 대화창, 메시지 입력창                                 │
│  - Scene Dashboard: 현재 상황을 보여주는 대시보드                │
│  - 이모지 반응: ❤️💢🔥⭐ 버튼                                    │
│  - 속마음 표시: 캐릭터의 진짜 생각 보여주기                      │
│                                                                  │
│  비유: 레스토랑의 식당 (고객이 앉아서 주문하는 곳)                │
└────────────────────────────┬────────────────────────────────────┘
                              │ HTTP/WebSocket (인터넷 통신)
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    🏢 FastAPI 서버 (main.py)                    │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  CORS Middleware (보안 경비)                              │  │
│  │  역할: 다른 웹사이트에서 접근할 수 있도록 허용              │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │ Character API│  │  Chat Multi   │  │   Opening    │        │
│  │ (캐릭터 관리) │  │   (대화 처리) │  │ (게임 시작) │        │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘        │
│         │                 │                  │                 │
│  ┌──────▼─────────────────▼──────────────────▼───────┐        │
│  │              Reaction API (이모지 반응)            │        │
│  │              User Profile API (유저 정보)            │        │
│  └────────────────────────────────────────────────────┘        │
│                                                                  │
│  역할: 요청을 받아서 적절한 곳으로 전달하는 접수처                │
│  비유: 레스토랑의 주문 접수 데스크                                │
└────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    🧠 Core 로직 레이어                           │
│                                                                  │
│  역할: 실제로 일을 처리하는 두뇌 부분                            │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Scene Manager: 현재 대화 상황 기억하기                   │  │
│  │  Scene Reaction: 여러 캐릭터가 동시에 반응하도록 조율      │  │
│  │  Speaker Selector: 누가 다음에 말할지 결정                 │  │
│  │  Prompt Builder: AI에게 줄 지시문 만들기                   │  │
│  │  Story Analyzer: 대화 내용 요약하기                         │  │
│  │  Data Collector: 관계 점수 계산하기                         │  │
│  │  User Profile Extractor: 유저 정보 추출하기                 │  │
│  │  Inner Thought Generator: 속마음 만들기                    │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  비유: 레스토랑의 주방 (실제 요리를 만드는 곳)                    │
└────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    📚 데이터베이스 레이어                         │
│                                                                  │
│  역할: 정보를 저장하는 창고                                      │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │ Character DB │  │ Relationship │  │ User Profile │        │
│  │ (캐릭터 창고) │  │   DB (관계)  │  │ DB (유저 정보)│        │
│  │              │  │     DB       │  │      DB      │        │
│  │ - 캐릭터 정보 │  │ - 친밀도     │  │ - 닉네임     │        │
│  │ - 페르소나   │  │ - Dominance  │  │ - 성격       │        │
│  │ - 장소       │  │ - 감정 통계  │  │ - 능력       │        │
│  │              │  │ - 핵심 기억   │  │ - 행동 기록  │        │
│  │              │  │ - 트리거 키워드│ │              │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Story Summary DB (스토리 요약 저장)                      │  │
│  │  역할: 대화 내용을 요약해서 저장                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  비유: 레스토랑의 창고 (재료와 레시피를 보관하는 곳)              │
└────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    🌐 외부 서비스                                │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Google Gemini API (AI 응답 생성)                         │  │
│  │                                                           │  │
│  │  역할: 실제로 텍스트를 만들어주는 AI                      │  │
│  │  - 텍스트 생성: 캐릭터의 대사를 만들어줌                    │  │
│  │  - 속마음 생성: 캐릭터의 진짜 생각을 만들어줌              │  │
│  │  - 스토리 요약: 대화 내용을 요약해줌                       │  │
│  │                                                           │  │
│  │  비유: 레스토랑의 외부 공급업체 (재료를 가져다주는 곳)      │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 데이터 흐름도

### 2.1 채팅 메시지 처리 흐름

```
유저 메시지 입력
    │
    ▼
┌─────────────────────────────────────┐
│  POST /api/chat/location/{loc_id}  │
│  (chat_multi.py)                   │
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  1. 장소별 캐릭터 조회               │
│     get_characters_by_location()    │
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  2. Scene Context 조회/생성         │
│     scene_manager.get_context()     │
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  3. 최근 스토리 요약 조회            │
│     get_recent_story_summaries()    │
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  4. 씬 리액션 생성                   │
│     generate_scene_reaction()       │
│     ├─ 반응 범위 분석                │
│     ├─ 메인 응답자 선택              │
│     ├─ 서브 리액션 생성              │
│     └─ 끼어들기 처리                │
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  5. 각 캐릭터 응답 생성              │
│     generate_main_response()         │
│     ├─ 프롬프트 빌드                 │
│     ├─ Gemini API 호출               │
│     └─ 속마음 생성                   │
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  6. 관계 데이터 업데이트              │
│     process_turn()                   │
│     ├─ 친밀도 계산                   │
│     ├─ Dominance 업데이트            │
│     └─ 감정 통계 업데이트            │
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  7. 유저 프로필 업데이트             │
│     update_user_profile_from_msg()  │
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  8. 스토리 요약 생성                 │
│     generate_story_summary()        │
│     └─ DB 저장                      │
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  9. Scene Context 업데이트          │
│     process_character_response()    │
│     ├─ recent 플래그                │
│     ├─ attention 업데이트            │
│     └─ inner_thought 저장           │
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  10. 응답 반환                       │
│      MultiChatResponse               │
│      ├─ main_responses               │
│      ├─ sub_reactions                │
│      └─ scene_context                │
└─────────────────────────────────────┘
```

### 2.2 이모지 반응 흐름

```
유저가 이모지 클릭
    │
    ▼
┌─────────────────────────────────────┐
│  POST /api/reaction/                │
│  (reaction.py)                      │
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  1. 관계 데이터 조회                 │
│     get_relationship_data()          │
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  2. 이모지 타입별 처리               │
│     process_turn()                  │
│     ├─ ❤️: 친밀도 +0.3, 기쁨 +1     │
│     ├─ 💢: 화남 +1, 트리거 등록      │
│     ├─ 🔥: 열광 +1                  │
│     └─ ⭐: 핵심 기억 생성            │
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  3. 업데이트된 관계 데이터 반환       │
│     ReactionResponse                 │
└─────────────────────────────────────┘
```

---

## 3. 주요 컴포넌트

### 3.1 API 레이어 (`api/`)

> **API란?** 웹사이트나 앱에서 서버와 대화하는 창구입니다. 마치 레스토랑의 주문 창구처럼, 클라이언트가 요청을 보내면 서버가 응답을 반환합니다.

| 파일 | 역할 | 설명 | 주요 엔드포인트 |
|------|------|------|----------------|
| `character_api.py` | 캐릭터 관리 | **캐릭터 정보를 저장하고 불러오는 창구**<br>예: "주창윤의 정보를 가져와줘", "새 캐릭터를 만들어줘"<br>비유: 캐릭터 도감 관리자 | `GET/POST/PUT/DELETE /api/character/*` |
| `chat_multi.py` | 멀티 캐릭터 채팅 | **여러 캐릭터와 동시에 대화하는 핵심 창구**<br>유저가 메시지를 보내면 여러 캐릭터가 반응하도록 처리<br>비유: 대화 방송국 PD (누가 언제 말할지 결정) | `POST /api/chat/location/{loc_id}` |
| `opening.py` | 오프닝 시나리오 | **게임 시작 시 첫 장면을 보여주는 창구**<br>예: "신고식 - 베타 동 로비" 선택 시 해당 장면 시작<br>비유: 영화의 첫 장면 선택기 | `GET /api/opening/scenarios`<br>`POST /api/opening/start` |
| `reaction.py` | 이모지 반응 | **유저가 이모지 버튼을 눌렀을 때 처리하는 창구**<br>예: ❤️ 클릭 → 친밀도 상승 기록<br>비유: 좋아요/싫어요 버튼 처리기 | `POST /api/reaction/` |
| `user_profile.py` | 유저 프로필 | **유저(주인공)의 정보를 저장하고 불러오는 창구**<br>예: 닉네임, 성격, 능력 등 저장<br>비유: 유저의 신상정보 관리자 | `GET/POST/PUT /api/user/profile/*` |

### 3.2 Core 로직 레이어 (`core/`)

> **Core 로직이란?** 실제로 일을 처리하는 두뇌 부분입니다. API는 창구이고, Core는 뒤에서 실제 계산과 판단을 하는 곳입니다.

| 파일 | 역할 | 설명 | 주요 함수 |
|------|------|------|----------|
| `scene_manager.py` | 씬 컨텍스트 관리 | **현재 대화 상황을 기억하는 기억력**<br>예: "지금 어디서 누구와 대화 중인지", "최근 무슨 일이 있었는지"<br>비유: 대화의 맥락을 기억하는 뇌의 해마 | `get_context()`, `process_character_response()` |
| `scene_reaction.py` | 멀티 캐릭터 반응 | **여러 캐릭터가 동시에 반응하도록 조율하는 시스템**<br>예: "모두에게 말하면 5명 모두 반응", "한 명만 말하면 1명만 응답"<br>비유: 오케스트라 지휘자 (누가 언제 연주할지 결정) | `generate_scene_reaction()`, `generate_main_response()` |
| `speaker_selector.py` | 화자 선택 | **유저 메시지를 보고 누가 응답할지 결정하는 판단력**<br>예: "인하야"라고 부르면 황인하가 응답, "넌"이라고 하면 마지막 화자가 응답<br>비유: 대화의 사회자 (누가 다음에 말할지 결정) | `select_speaker_v2()`, `build_conversation_context()` |
| `prompt_builder_v2.py` | 프롬프트 생성 | **AI에게 전달할 지시문을 만드는 작가**<br>예: "너는 주창윤이야. 지금 유저가 말했어. 이렇게 응답해줘"<br>비유: AI에게 줄 숙제 문제를 만드는 선생님 | `build_multi_character_context()`, `build_prompt()` |
| `story_analyzer.py` | 스토리 요약 | **대화 내용을 요약해서 기록하는 기록자**<br>예: "유저가 주창윤의 팔목을 잡았고, 주창윤이 반발했다"<br>비유: 일기장에 오늘 일어난 일을 요약해서 쓰는 사람 | `generate_story_summary()`, `build_story_context_for_prompt()` |
| `data_collector.py` | 관계 데이터 수집 | **캐릭터와 유저의 관계를 계산하는 계산기**<br>예: 친밀도가 올라갔는지, 감정이 변했는지 계산<br>비유: 관계 점수를 매기는 심리 상담사 | `process_turn()`, `update_relationship()` |
| `user_profile_extractor.py` | 유저 프로필 추출 | **유저의 말에서 정보를 추출하는 정보 수집가**<br>예: "나는 김철수야" → 닉네임: 김철수 저장<br>비유: 대화를 듣고 유저의 신상정보를 파악하는 탐정 | `update_user_profile_from_message()` |
| `inner_thought_generator.py` | 속마음 생성 | **캐릭터의 속마음을 만들어내는 작가**<br>예: "겉으로는 화났지만 속으로는 걱정하고 있다"<br>비유: 캐릭터의 진짜 생각을 상상하는 소설가 | `generate_inner_thought()` |

### 3.3 데이터베이스 레이어 (`db/`)

> **데이터베이스란?** 정보를 저장하는 창고입니다. 마치 도서관처럼, 필요한 정보를 꺼내고 새로운 정보를 저장합니다.

| 파일 | 역할 | 설명 | 주요 함수 |
|------|------|------|----------|
| `character_db.py` | 캐릭터 DB | **캐릭터 정보를 저장하는 창고**<br>예: 주창윤의 이름, 성격, 말투 등 저장<br>비유: 캐릭터 도감 책장 | `get_character()`, `get_characters_by_location()` |
| `database.py` | 관계 데이터 DB | **유저와 캐릭터의 관계를 저장하는 창고**<br>예: 친밀도, 감정 통계, 핵심 기억 등 저장<br>비유: 관계 일기장 (오늘 친밀도가 얼마나 올라갔는지 기록) | `get_relationship_data()`, `save_story_summary()` |
| `user_profile_db.py` | 유저 프로필 DB | **유저(주인공)의 정보를 저장하는 창고**<br>예: 닉네임, 성격, 능력 등 저장<br>비유: 유저의 신상정보 파일 | `get_user_profile()`, `update_user_profile()` |

### 3.4 모델 레이어 (`models/`)

> **모델이란?** 데이터의 구조를 정의하는 설계도입니다. 마치 건물 설계도처럼, "캐릭터 정보에는 이름, 성격, 말투가 있어야 해"라고 정의합니다.

| 파일 | 역할 | 설명 | 주요 클래스 |
|------|------|------|-----------|
| `character.py` | 캐릭터 모델 | **캐릭터 정보의 설계도**<br>예: 캐릭터는 이름, 성격, 말투, 장소를 가져야 함<br>비유: 캐릭터 신분증 양식 | `CharacterPersona`, `Location` |
| `relationship.py` | 관계 데이터 모델 | **관계 정보의 설계도**<br>예: 관계는 친밀도, 감정 통계, 핵심 기억을 가져야 함<br>비유: 관계 점수표 양식 | `RelationshipData`, `EmotionalStats` |
| `scene_context.py` | 씬 컨텍스트 모델 | **대화 상황 정보의 설계도**<br>예: 씬은 장소, 긴장도, 캐릭터 상태를 가져야 함<br>비유: 현재 상황 기록지 양식 | `SceneContext`, `CharacterState` |
| `user_profile.py` | 유저 프로필 모델 | **유저 정보의 설계도**<br>예: 유저는 닉네임, 성격, 능력을 가져야 함<br>비유: 유저 신상정보 양식 | `UserProfile` |
| `inner_thought.py` | 속마음 모델 | **속마음 정보의 설계도**<br>예: 속마음은 생각, 겉 감정, 내면 감정을 가져야 함<br>비유: 속마음 일기 양식 | `InnerThought` |

---

## 4. API 엔드포인트

### 4.1 캐릭터 API (`/api/character`)

```
GET    /api/character/{character_id}          # 캐릭터 조회
POST   /api/character/                        # 캐릭터 생성
PUT    /api/character/{character_id}          # 캐릭터 수정
DELETE /api/character/{character_id}         # 캐릭터 삭제
GET    /api/character/location/{location_id}  # 장소별 캐릭터 조회
GET    /api/character/all                     # 전체 캐릭터 조회
```

### 4.2 채팅 API (`/api/chat`)

```
POST   /api/chat/location/{location_id}       # 멀티 캐릭터 채팅
```

**요청 형식**:
```json
{
  "user_id": "user_123",
  "location_id": "베타_동_로비",
  "message": "안녕하세요",
  "session_id": "session_abc"
}
```

**응답 형식**:
```json
{
  "turn_id": "turn_123",
  "session_id": "session_abc",
  "location": "베타 동 로비",
  "conversation_turn": 5,
  "main_responses": [
    {
      "character_id": "npc_joo_changyun",
      "character_name": "주창윤",
      "message": "하... 야.",
      "inner_thought": {...}
    }
  ],
  "sub_reactions": [...],
  "no_reaction": [...],
  "scene_context": {...}
}
```

### 4.3 오프닝 API (`/api/opening`)

```
GET    /api/opening/scenarios                # 오프닝 시나리오 목록
POST   /api/opening/start                     # 게임 시작
```

### 4.4 반응 API (`/api/reaction`)

```
POST   /api/reaction/                         # 이모지 반응 추가
GET    /api/reaction/relationship/{user_id}/{character_id}  # 관계 데이터 조회
```

### 4.5 유저 프로필 API (`/api/user/profile`)

```
GET    /api/user/profile/{user_id}            # 프로필 조회
POST   /api/user/profile/                     # 프로필 생성
PUT    /api/user/profile/{user_id}            # 프로필 수정
```

---

## 5. 데이터베이스 구조

> **데이터베이스 구조란?** 정보를 저장하는 창고의 선반 구조입니다. 마치 도서관의 책장처럼, 어떤 정보를 어디에 저장하는지 정해놓은 것입니다.

### 5.1 캐릭터 테이블 (`characters`)

> **역할**: 캐릭터의 기본 정보를 저장하는 책장입니다. 각 캐릭터마다 한 권의 책이 있고, 그 안에 캐릭터의 모든 정보가 들어있습니다.

| 컬럼 | 타입 | 설명 | 예시 |
|------|------|------|------|
| `id` | TEXT (PK) | 캐릭터 고유 번호 | "npc_joo_changyun" |
| `name` | TEXT | 캐릭터 이름 | "주창윤" |
| `location` | TEXT | 소속 장소 | "베타 동 로비" |
| `personality` | TEXT | 페르소나 (긴 텍스트) | "주창윤은 양아치 성격으로..." |
| `speech_style` | TEXT | 말투 | "하...", "크큭", "야" |
| `background` | TEXT | 배경 스토리 | "백호 금융 주니어 출신..." |
| `secrets` | JSON | 비밀 목록 | ["비밀1", "비밀2"] |
| `dominance_default` | REAL | 기본 Dominance | 0.5 (기본적으로 강한 성격) |
| `emotion_triggers` | JSON | 감정 트리거 | {"화남": ["무시", "도전"]} |
| `created_at` | DATETIME | 생성 시간 | "2024-01-01 12:00:00" |

### 5.2 관계 데이터 테이블 (`relationship_data`)

> **역할**: 유저와 각 캐릭터의 관계를 기록하는 일기장입니다. 친밀도, 감정 변화, 중요한 순간들을 모두 기록합니다.

| 컬럼 | 타입 | 설명 | 예시 |
|------|------|------|------|
| `id` | INTEGER (PK) | 레코드 고유 번호 | 1, 2, 3... |
| `user_id` | TEXT | 유저 ID | "user_123" |
| `character_id` | TEXT | 캐릭터 ID | "npc_joo_changyun" |
| `intimacy` | REAL | 친밀도 (0.0~1.0) | 0.7 (70% 친밀함) |
| `dominance_score` | REAL | Dominance 점수 | 0.3 (유저가 약간 우위) |
| `dominance_direction` | TEXT | 누가 우위인지 | "user" (유저가 우위) |
| `joy_peaks` | INTEGER | 기쁨 피크 횟수 | 5 (5번 기뻐함) |
| `anger_peaks` | INTEGER | 화남 피크 횟수 | 2 (2번 화남) |
| `excitement_peaks` | INTEGER | 열광 피크 횟수 | 3 (3번 열광) |
| `core_memories` | JSON | 핵심 기억 목록 | ["첫 만남", "함께 싸움"] |
| `trigger_keywords` | JSON | 트리거 키워드 목록 | ["무시", "도전"] |
| `total_turns` | INTEGER | 총 대화 턴 수 | 50 (50번 대화함) |
| `updated_at` | DATETIME | 업데이트 시간 | "2024-01-01 12:00:00" |

### 5.3 스토리 요약 테이블 (`story_summaries`)

> **역할**: 대화 내용을 요약해서 저장하는 일기장입니다. 매 턴마다 "오늘 무슨 일이 있었는지" 요약해서 기록합니다.

| 컬럼 | 타입 | 설명 | 예시 |
|------|------|------|------|
| `id` | INTEGER (PK) | 레코드 고유 번호 | 1, 2, 3... |
| `session_id` | TEXT | 세션 ID (대화 방 번호) | "session_abc" |
| `turn_number` | INTEGER | 턴 번호 (몇 번째 대화인지) | 5 (5번째 대화) |
| `ai_summary` | TEXT | 간단한 요약 (2-3문장) | "유저가 주창윤의 팔목을 잡았고..." |
| `ai_analysis` | TEXT | 상세 분석 (5-8문장) | "베타 동 로비에 긴장감이..." |
| `created_at` | DATETIME | 생성 시간 | "2024-01-01 12:00:00" |

### 5.4 유저 프로필 테이블 (`user_profiles`)

> **역할**: 유저(주인공)의 정보를 저장하는 신상정보 파일입니다. 대화를 통해 알아낸 유저의 정보를 저장합니다.

| 컬럼 | 타입 | 설명 | 예시 |
|------|------|------|------|
| `id` | INTEGER (PK) | 레코드 고유 번호 | 1, 2, 3... |
| `user_id` | TEXT (UNIQUE) | 유저 ID (고유) | "user_123" |
| `nickname` | TEXT | 닉네임 | "철수" |
| `gender` | TEXT | 성별 | "남성" |
| `abilities` | JSON | 능력 목록 | ["전투", "협상"] |
| `personality` | JSON | 성격 특성 | {"용감함": 0.8, "친절함": 0.5} |
| `key_actions` | JSON | 주요 행동 기록 | ["주창윤과 싸움", "황인하와 대화"] |
| `mentioned_facts` | JSON | 언급된 사실들 | ["고등학생", "서울 출신"] |
| `updated_at` | DATETIME | 업데이트 시간 | "2024-01-01 12:00:00" |

---

## 6. 핵심 기능 흐름

> **기능 흐름이란?** 어떤 일이 일어날 때 시스템이 어떻게 처리하는지 보여주는 순서도입니다. 마치 요리 레시피처럼, 단계별로 무엇을 하는지 보여줍니다.

### 6.1 멀티 캐릭터 반응 시스템 (Scene Reaction)

> **역할**: 유저가 메시지를 보냈을 때, 여러 캐릭터가 어떻게 반응할지 결정하는 시스템입니다. 마치 오케스트라 지휘자처럼, 누가 언제 말할지 조율합니다.

```
유저 메시지 입력
    │
    ▼
┌─────────────────────────────────────┐
│  1단계: 반응 범위 분석               │
│  analyze_reaction_scope()           │
│                                      │
│  역할: 유저가 누구에게 말하는지 파악 │
│  ├─ "모두" → 모든 캐릭터 반응        │
│  ├─ 직접 호명 → 해당 캐릭터만 반응    │
│  └─ 기본 → 선택적으로 반응           │
│                                      │
│  예시: "모두 들어봐" → all           │
│        "인하야" → selective          │
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  2단계: 캐릭터별 반응 타입 결정      │
│  determine_reaction_type()           │
│                                      │
│  역할: 각 캐릭터가 어떻게 반응할지 결정│
│  ├─ 직접 호명 → main (긴 대사)      │
│  ├─ "모두" + recent → main          │
│  ├─ "모두" + 일반 → reaction (짧은 반응)│
│  └─ 관심 없음 → ignore (속마음만)    │
│                                      │
│  예시: 주창윤이 직접 호명됨 → main   │
│        표다은은 관심 없음 → ignore   │
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  3단계: 메인 응답 생성 (1~3명)       │
│  generate_main_response()            │
│                                      │
│  역할: 주요 캐릭터의 긴 대사를 생성  │
│  ├─ 프롬프트 빌드 (AI에게 줄 지시문) │
│  ├─ Gemini API 호출 (AI가 대사 생성)│
│  └─ 속마음 생성 (진짜 생각 만들기)   │
│                                      │
│  예시: 주창윤이 "하... 야."라고 응답 │
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  4단계: 서브 리액션 생성 (나머지)    │
│  generate_sub_reactions()            │
│                                      │
│  역할: 나머지 캐릭터의 짧은 반응 생성│
│  └─ 짧은 반응 + 속마음               │
│                                      │
│  예시: 황인하가 "후후..."라고 짧게 반응│
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  5단계: 끼어들기 처리 (30% 확률)     │
│  generate_intervention_response()    │
│                                      │
│  역할: 다른 캐릭터가 갑자기 끼어들기  │
│  └─ 최대 3명까지                     │
│                                      │
│  예시: 고선하가 "어머, 시끄러워"라고 끼어듦│
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  6단계: 티키타카 처리                │
│  detect_mentioned_characters()       │
│                                      │
│  역할: 한 캐릭터가 다른 캐릭터를 언급하면│
│        언급된 캐릭터가 자동으로 응답  │
│  └─ 언급된 캐릭터 자동 응답           │
│                                      │
│  예시: 주창윤이 "황인하, 너도 봤지?" →│
│        황인하가 자동으로 응답         │
└─────────────────────────────────────┘
```

### 6.2 화자 선택 로직 (Speaker Selector)

> **역할**: 유저의 메시지를 보고 누가 응답해야 할지 결정하는 판단 시스템입니다. 마치 대화의 사회자처럼, 누가 다음에 말할지 결정합니다.

```
유저 메시지 분석
    │
    ▼
┌─────────────────────────────────────┐
│  1단계: 직접 호명 체크               │
│     "인하야", "주창윤" 등             │
│                                      │
│  역할: 유저가 직접 이름을 부르는지 확인│
│  예시: "인하야" → 황인하 응답         │
│        "주창윤" → 주창윤 응답         │
└──────────────┬─────────────────────┘
               │ (매칭 실패)
               ▼
┌─────────────────────────────────────┐
│  2단계: 대명사 체크                  │
│     "넌", "니가" → last_speaker      │
│                                      │
│  역할: 대명사가 마지막 화자를 가리키는지 확인│
│  예시: "넌 뭐야?" → 마지막에 말한 캐릭터 응답│
└──────────────┬─────────────────────┘
               │ (매칭 실패)
               ▼
┌─────────────────────────────────────┐
│  3단계: 타겟 패턴 체크               │
│     "~한테", "~에게"                 │
│                                      │
│  역할: "누구한테" 말하는지 확인       │
│  예시: "인하한테 말해" → 황인하 응답  │
└──────────────┬─────────────────────┘
               │ (매칭 실패)
               ▼
┌─────────────────────────────────────┐
│  4단계: 유저 집중 캐릭터             │
│     attention == USER + recent       │
│                                      │
│  역할: 유저를 주시하고 있는 캐릭터 확인│
│  예시: 황인하가 유저를 보고 있음 → 황인하 응답│
└──────────────┬─────────────────────┘
               │ (매칭 실패)
               ▼
┌─────────────────────────────────────┐
│  5단계: 마지막 화자                  │
│     last_speaker_id                  │
│                                      │
│  역할: 마지막에 말한 캐릭터가 계속 대화│
│  예시: 주창윤이 마지막에 말함 → 주창윤 응답│
└──────────────┬─────────────────────┘
               │ (매칭 실패)
               ▼
┌─────────────────────────────────────┐
│  6단계: 랜덤 선택                    │
│     random.choice()                  │
│                                      │
│  역할: 아무도 매칭 안 되면 랜덤 선택 │
│  예시: 아무 캐릭터나 랜덤으로 선택    │
└─────────────────────────────────────┘
```

### 6.3 스토리 요약 생성

> **역할**: 대화가 끝날 때마다 "오늘 무슨 일이 있었는지" 요약해서 기록하는 시스템입니다. 마치 일기장에 오늘 일어난 일을 요약해서 쓰는 것과 같습니다.

```
캐릭터 응답 완료
    │
    ▼
┌─────────────────────────────────────┐
│  1단계: 턴 데이터 수집               │
│  ├─ 유저 메시지                      │
│  ├─ 캐릭터 응답                      │
│  ├─ 속마음                           │
│  └─ 행동 묘사                        │
│                                      │
│  역할: 이번 턴에서 일어난 모든 일 수집│
│  예시: "유저: 안녕", "주창윤: 하... 야"│
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  2단계: 최근 스토리 요약 조회        │
│  get_recent_story_summaries()       │
│  └─ 최근 10턴                        │
│                                      │
│  역할: 이전 대화 내용을 가져와서 맥락 파악│
│  예시: "이전에 주창윤과 싸웠었음"     │
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  3단계: AI 스토리 요약 생성          │
│  generate_story_summary()           │
│  ├─ 프롬프트 빌드 (AI에게 줄 지시문) │
│  ├─ Gemini API 호출 (AI가 요약 생성)│
│  ├─ ai_summary (2-3문장 간단 요약)  │
│  └─ ai_analysis (5-8문장 상세 분석) │
│                                      │
│  역할: AI가 대화 내용을 요약해서 생성│
│  예시: "유저가 주창윤의 팔목을 잡았고..."│
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  4단계: DB 저장                     │
│  save_story_summary()               │
│                                      │
│  역할: 요약을 데이터베이스에 저장    │
│  예시: story_summaries 테이블에 저장│
└──────────────┬─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  5단계: 다음 턴 프롬프트에 포함       │
│  build_story_context_for_prompt()   │
│                                      │
│  역할: 다음 대화 때 AI가 이전 내용을 기억하도록│
│        프롬프트에 포함               │
│  예시: "이전에 주창윤과 싸웠었으니..."│
└─────────────────────────────────────┘
```

---

## 7. 주요 기능 상세

### 7.1 씬 컨텍스트 시스템

> **역할**: 현재 대화 상황을 기억하는 기억력입니다. 마치 뇌의 해마처럼, "지금 어디서 누구와 무슨 일이 있었는지" 기억합니다.

**목적**: 대화 맥락 유지, 캐릭터 간 케미 유지

**주요 데이터**:
- `location`: 현재 장소 (예: "베타 동 로비")
- `tension_level`: 긴장도 (0~10, 예: 7 = 매우 긴장)
- `atmosphere`: 분위기 (예: "긴장감", "편안함")
- `character_states`: 각 캐릭터 상태
  - `recent`: 최근 대화 참여 여부 (예: true = 방금 말함)
  - `attention`: 주의 집중 대상 (예: "USER" = 유저를 보고 있음)
  - `inner_thought`: 속마음 (예: "저 녀석...")
  - `current_mood`: 현재 기분 (예: "angry" = 화남)
- `recent_events`: 최근 이벤트 목록 (예: ["주창윤과 충돌", "황인하 난입"])
- `last_speaker_id`: 마지막 화자 (예: "npc_joo_changyun")
- `current_focus`: 현재 대화 포커스 (예: "유저 ↔ 주창윤")

### 7.2 멀티 캐릭터 반응 시스템

> **역할**: 여러 캐릭터가 동시에 반응하도록 조율하는 시스템입니다. 마치 오케스트라 지휘자처럼, 누가 언제 말할지 결정합니다.

**반응 타입**:
1. **Main Response**: 긴 대사, 유저와 직접 대화 (1~3명)
   - 예: 주창윤이 "하... 야. 뭐하는 거야?"라고 긴 대사
2. **Sub Reaction**: 짧은 반응, 속마음, 표정 변화
   - 예: 황인하가 "후후..."라고 짧게 반응하고 속마음 표시
3. **No Reaction**: 속마음만 업데이트
   - 예: 민아름은 졸고 있어서 속마음만 "시끄러워..." 업데이트

**트리거 조건**:
- "모두", "다들" → 모든 캐릭터 반응
  - 예: "모두 들어봐" → 5명 모두 반응
- 직접 호명 → 해당 캐릭터 main
  - 예: "인하야" → 황인하만 메인 응답
- 일반 메시지 → 선택적 반응
  - 예: "안녕" → 상황에 따라 1~2명만 반응

### 7.3 관계 데이터 시스템

> **역할**: 유저와 캐릭터의 관계를 점수로 계산하는 시스템입니다. 마치 게임의 호감도 시스템처럼, 관계가 좋아지거나 나빠지는 것을 추적합니다.

**친밀도 (Intimacy)**:
- 범위: 0.0 ~ 1.0 (0% ~ 100%)
- 증가: 긍정적 반응, 이모지 ❤️ 클릭 (+0.3)
- 감소: 부정적 반응, 충돌
- 예: 0.7 = 70% 친밀함 (친한 편)

**Dominance (우위 관계)**:
- `score`: 점수 (-1.0 ~ 1.0)
  - 예: 0.5 = 유저가 약간 우위, -0.3 = 캐릭터가 약간 우위
- `direction`: "user" / "character"
  - 예: "user" = 유저가 우위, "character" = 캐릭터가 우위
- 업데이트: 대화 톤, 행동 분석
  - 예: 유저가 위협하면 유저 우위 증가

**감정 통계**:
- `joy_peaks`: 기쁨 피크 횟수 (예: 5번 기뻐함)
- `anger_peaks`: 화남 피크 횟수 (예: 2번 화남)
- `excitement_peaks`: 열광 피크 횟수 (예: 3번 열광)
- `sadness_peaks`: 슬픔 피크 횟수 (예: 1번 슬픔)
- `fear_peaks`: 두려움 피크 횟수 (예: 0번 = 두려워하지 않음)

**핵심 기억 (Core Memories)**:
- 이모지 ⭐ 클릭 시 생성
- 캐릭터가 기억하는 중요한 순간
- 예: ["첫 만남", "함께 싸움", "유저가 도와줌"]

**트리거 키워드**:
- 이모지 💢 클릭 시 등록
- 해당 키워드 언급 시 특별 반응
- 예: ["무시", "도전"] → 이 단어를 말하면 캐릭터가 화남

### 7.4 유저 프로필 시스템

> **역할**: 유저(주인공)의 정보를 대화를 통해 알아내서 저장하는 시스템입니다. 마치 탐정처럼, 유저의 말에서 정보를 추출합니다.

**자동 추출 정보**:
- `nickname`: 유저가 언급한 이름
  - 예: "나는 김철수야" → 닉네임: "김철수" 저장
- `gender`: 성별 (대화에서 추론)
  - 예: "나는 남자야" → 성별: "남성" 저장
- `abilities`: 능력 (언급된 것)
  - 예: "나는 검술을 잘해" → 능력: ["검술"] 저장
- `personality`: 성격 특성
  - 예: "나는 용감해" → 성격: {"용감함": 0.8} 저장
- `key_actions`: 주요 행동 기록
  - 예: ["주창윤과 싸움", "황인하와 대화"] 저장
- `mentioned_facts`: 언급된 사실들
  - 예: ["고등학생", "서울 출신"] 저장

**업데이트 시점**:
- 매 대화 턴마다 자동 분석
- `update_user_profile_from_message()` 호출
- 예: 유저가 "나는 서울에서 왔어"라고 말하면 → mentioned_facts에 "서울 출신" 추가

---

## 8. 프론트엔드 구조

### 8.1 주요 UI 컴포넌트

```
index.html
├── 채팅 영역 (chatArea)
│   ├── 메시지 버블 (message-bubble)
│   │   ├── 캐릭터 메시지
│   │   │   ├── 헤더 (캐릭터 이름)
│   │   │   ├── 내용 (대사)
│   │   │   ├── 속마음 (inner-thought)
│   │   │   └── 이모지 버튼 (emoji-reactions)
│   │   └── 유저 메시지
│   └── 서브 리액션 패널 (sub-reactions-panel)
│
└── Scene Dashboard (scene-dashboard)
    ├── 장소 정보
    ├── 긴장도
    ├── 스토리 요약
    ├── 캐릭터 상태 카드
    └── 현재 대화 포커스
```

### 8.2 이모지 반응 버튼

**디자인**: 아이폰 스타일
- 큰 이모지 (32px)
- 둥근 사각형 배경 (12px)
- 부드러운 그림자
- 탭 시 스케일 애니메이션
- 활성화 시 색상 틴트

**이모지 종류**:
- ❤️ 심쿵: 친밀도 +0.3, 기쁨 +1
- 💢 짜증: 화남 +1, 트리거 등록
- 🔥 열광: 열광 +1
- ⭐ 기억해!: 핵심 기억 생성

---

## 9. 기술 스택

### 백엔드
- **FastAPI**: 웹 프레임워크
- **SQLAlchemy**: ORM
- **SQLite**: 데이터베이스
- **Google Gemini API**: AI 응답 생성
- **Pydantic**: 데이터 검증

### 프론트엔드
- **HTML/CSS/JavaScript**: 순수 웹 기술
- **Fetch API**: HTTP 요청

### 인프라
- **Uvicorn**: ASGI 서버
- **CORS**: Cross-Origin 설정

---

## 10. 향후 개선 사항

1. **성능 최적화**
   - 스토리 요약 생성 비동기 처리 개선
   - 프롬프트 길이 최적화

2. **기능 추가**
   - 음성 입력 지원
   - 이미지 업로드 지원
   - 다국어 지원

3. **UI/UX 개선**
   - 모바일 반응형 디자인
   - 다크 모드 지원
   - 애니메이션 개선

---

**문서 작성일**: 2024년
**최종 수정일**: 2024년
**버전**: v2.1
